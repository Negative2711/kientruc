<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELearning</title>
    <!-- boostrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <!-- font awesome -->
    <script src="https://kit.fontawesome.com/ad778f42b3.js" crossorigin="anonymous"></script>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- toastr -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/manager-section-class.css">
    <!-- select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <style>
        .select2-selection__rendered {
          line-height: 28px !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row" style="height: 100vh;">
            <div class="col-lg-2 border-end p-3">
                <div class="my-1">
                    <button class="myButton3" onclick="window.location.href=('./manager-home.html');">Home</button>
                </div>
                <div class="my-1">
                    <button class="myButton2">Qu·∫£n l√Ω LHP</button>
                </div>
                <div class="mt-2">
                    <button class="myButton3" onclick="window.location.href=('./manager-time-table.html');">Qu·∫£n l√Ω TKB</button>
                </div>
            </div>
            <div class="col-lg-4 border-end">
                <div class="d-flex my-3">
                    <a href="./manager-home.html">Home</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="./manager-section-class.html">Section class</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="javascript:void(0);">Create new</a>
                </div>
                <form id="FormSectionClass" method="post">
                    <div>
                        <label for="">T√™n l·ªõp ƒë·∫°i di·ªán</label>
                        <input type="text" name="sectionClassNamePresent" placeholder="Nh·∫≠p t√™n l·ªõp ƒë·∫°i di·ªán.." >
                    </div>
                    <div>
                        <label for="">S·ªë l∆∞·ª£ng sinh vi√™n</label>
                        <input type="text" name="maxStudent" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng sinh vi√™n t·ªëi ƒëa.." >
                    </div>
                    <div>
                        <label for="">Ng√†y b·∫Øt ƒë·∫ßu</label>
                        <input type="date" name="startDate" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng sinh vi√™n t·ªëi ƒëa.." >
                    </div>
                    <div>
                        <label for="">Ng√†y k·∫øt th√∫c</label>
                        <input type="date" name="endDate" placeholder="Nh·∫≠p ng√†y k·∫øt th√∫c.." >
                    </div>
                    <div>
                        <label for="">M√£ m√¥n h·ªçc</label>
                        <select name="subjectId" class="js-example-subject-select2-single">
                            <option value="" selected>Vui l√≤ng ch·ªçn m√£ m√¥n h·ªçc</option>
                        </select>
                    </div>
                    <div>
                        <label for="">M√£ gi√°o vi√™n</label>
                        <select name="teacherId" class="js-example-teacher-select2-single">
                            <option value="" selected>Vui l√≤ng ch·ªçn m√£ gi√°o vi√™n</option>
                        </select>
                    </div>
                    <div>
                        <label for="">M√£ h·ªçc k·ª≥</label>
                        <select name="semesterSchoolId" class="js-example-semester-select2-single">
                            <option value="" selected>Vui l√≤ng ch·ªçn m√£ h·ªçc k√¨</option>
                        </select>
                    </div>
                    <div>
                        <label for="">Ph√¢n nh√≥m</label>
                        <select name="groups">
                            <option value="0">Kh√¥ng ph√¢n nh√≥m</option>
                            <option value="2">Chia l√†m 2 nh√≥m</option>
                            <option value="3">Chia l√†m 3 nh√≥m</option>
                        </select>
                    </div>
                    <div>
                        <label for="sectionClassType">Tr·∫°ng th√°i LHP</label>
                        <select name="sectionClassType" id="sectionClassType">
                            <option value="HOC_MOI" selected>H·ªçc m·ªõi</option>
                            <option value="HOC_LAI">H·ªçc l·∫°i</option>
                            <option value="HOC_CAI_THIEN">H·ªçc c·∫£i thi·ªán</option>
                        </select>
                    </div>
                    <div>
                        <label for="">Tr·∫°ng th√°i LHP</label>
                        <select name="lockStatus">
                            <option value="DANG_CHO_SINH_VIEN_DANG_KY">ƒêang ch·ªù SV ƒëƒÉng k√Ω</option>
                            <option value="CHAP_NHAN_MO_LOP">Ch·∫•p nh·∫≠n m·ªü l·ªõp</option>
                            <option value="DA_KHOA">ƒê√£ kh√≥a</option>
                        </select>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btnSubmit">Submit</button>
                    </div>
                </form>
            </div>
            <div class="col-lg-6">
                <div class="d-flex my-3">
                    <a href="./manager-home.html">Home</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="./manager-section-class.html">Section class</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="javascript:void(0);">List</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>M√£ LHP</th>
                                <th>T√™n l·ªõp ƒêD</th>
                                <th>Lo·∫°i h·ªçc</th>
                                <th>H·ªçc k·ª≥</th>
                                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                                <th>Ng√†y k·∫øt th√∫c</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>ƒê√£ ƒëƒÉng k√Ω</th>
                                <th>M√¥n h·ªçc</th>
                                <th>Gi√°o vi√™n</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Tr·∫°ng th√°i LHP</th>
                            </tr>
                        </thead>
                        <tbody id="tBodySectionClasses">
                            <!-- Render By JQuery -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        var jwtToken;
        initSkeleton();

        async function initSkeleton() {
            validateSessionLogin();
            await setSubjectSeclection(); // L·∫•y ra list subjects & render
            await setTeacherSelection(); // L·∫•y ra list teachers & render
            await setSemesterSchoolSelection(); // L·∫•y ra list semesterSchools & render

            await renderTable();
        }

        function validateSessionLogin() {
            jwtToken = window.sessionStorage.getItem('token');
            if (!jwtToken || jwtToken == undefined || jwtToken == '') {
                window.location.href = "./manager-login.html";
            }
        }

        async function setSubjectSeclection() {
            try {
                const response = await fetch(`http://localhost:8080/manager/subject/list`, {// Get Subjects
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const subjects = await response.json();
                $('.js-example-subject-select2-single').select2({
                    placeholder: "Ch·ªçn m√¥n h·ªçc m·ªü LHP",
                    allowClear: true,
                    data: subjects.map(function(subject) {
                        return {
                            id: subject.id,
                            text: subject.id + ' - ' + subject.subjectName
                        };
                    }),
                });
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.responseText, 'L·ªói');
            }
        }

        async function setTeacherSelection() {
            try {
                const response = await fetch(`http://localhost:8080/manager/teacher/list`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const teachers = await response.json();
                $('.js-example-teacher-select2-single').select2({
                    placeholder: "Ch·ªçn gi√°o vi√™n d·∫°y LHP",
                    allowClear: true,
                    data: teachers.map(function(teacher) {
                        return {
                            id: teacher.id,
                            text: teacher.id + ' - ' + teacher.fullName
                        };
                    }),
                });
                const response3 = await fetch(`http://localhost:8080/manager/semesterSchool/list`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const semesterSchools = await response3.json();
                $('.js-example-semester-select2-single').select2({
                    placeholder: "Ch·ªçn m√£ h·ªçc k√¨ m·ªü LHP",
                    allowClear: true,
                    data: semesterSchools.map(function(semesterSchool) {
                        return {
                            id: semesterSchool.id,
                            text: semesterSchool.id + ' - ' + translateEnumric(semesterSchool.stageSemester)
                        };
                    }),
                });
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.responseText, 'L·ªói');
            }
        }

        async function setSemesterSchoolSelection() {
            try {
                const response = await fetch(`http://localhost:8080/manager/semesterSchool/list`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const semesterSchools = await response.json();
                $('.js-example-semester-select2-single').select2({
                    placeholder: "Ch·ªçn m√£ h·ªçc k√¨ m·ªü LHP",
                    allowClear: true,
                    data: semesterSchools.map(function(semesterSchool) {
                        return {
                            id: semesterSchool.id,
                            text: semesterSchool.id + ' - ' + translateEnumric(semesterSchool.stageSemester)
                        };
                    }),
                });
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.responseText, 'L·ªói');
            }
        }

        async function renderTable() {
            try {
                const response = await fetch(`http://localhost:8080/manager/sectionClass/list`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`,
                    },
                });
                const sectionClasses = await response.json();
                console.log('sectionClasses======', sectionClasses);
                sectionClasses.forEach(sectionClasse => {
                    const elementHtml = `
                        <tr>
                            <td>${sectionClasse.sectionClass.id}</td>
                            <td>${sectionClasse.sectionClass.sectionClassNamePresent}</td>
                            <td>${translateEnumric(sectionClasse.sectionClass.sectionClassType)}</td>
                            <td>${translateEnumric(sectionClasse.semesterSchool.stageSemester)} - ${sectionClasse.semesterSchool.year}</td>
                            <td>${formatDate(sectionClasse.sectionClass.startDate)}</td>
                            <td>${formatDate(sectionClasse.sectionClass.endDate)}</td>
                            <td>${sectionClasse.sectionClass.maxStudent}</td>
                            <td>${sectionClasse.sectionClass.registeredNumber}</td>
                            <td>${sectionClasse.subject.subjectName}</td>
                            <td>${sectionClasse.teacher.fullName}</td>
                            <td>${formatDate(sectionClasse.sectionClass.createdAt)}</td>
                            <td>${translateEnumric(sectionClasse.sectionClass.lockStatus)}</td>
                        </tr>
                    `;
                    $("#tBodySectionClasses").append(elementHtml);
                });
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.responseText, 'L·ªói');
            }
        }

        $(document).ready(function(){
            // 01. Listen Form Submit
            $("#FormSectionClass").submit(async function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                console.log('formData=', formData);
                const sectionClassNamePresent = formData.get('sectionClassNamePresent');
                const maxStudent = formData.get('maxStudent');
                const startDate = formData.get('startDate');
                const endDate = formData.get('endDate');
                const subjectId = formData.get('subjectId');
                const teacherId = formData.get('teacherId');
                const semesterSchoolId = formData.get('semesterSchoolId');
                const groups = formData.get('groups');
                const sectionClassType = formData.get('sectionClassType');
                const lockStatus = formData.get('lockStatus');

                // Pineline data
                const sectionClassDTO = {
                    sectionClassNamePresent,
                    maxStudent,
                    startDate,
                    endDate,
                    subjectId,
                    teacherId,
                    semesterSchoolId,
                    groups,
                    sectionClassType,
                    lockStatus,
                };
                try {
                    const response = await fetch(`http://localhost:8080/manager/sectionClass/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`,
                        },
                        body: JSON.stringify(sectionClassDTO)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                    const data = await response.json();
                    console.log('data=', data);
                    toastr.success(response.status, 'Th√†nh c√¥ng');
                } catch (error) {
                    console.error('error=', error);
                    toastr.error(error.responseText, 'L·ªói');
                }
            });
        });

        function translateEnumric(keyString) {
            const databases = {
                "DANG_CHO_SINH_VIEN_DANG_KY": "ƒêang ch·ªù sinh vi√™n ƒëƒÉng k√Ω",
                "CHAP_NHAN_MO_LOP": "Ch·∫•p nh·∫≠n m·ªü l·ªõp ‚ö†Ô∏è",
                "DA_KHOA": "ƒê√£ kh√≥a ‚õî",
                "LY_THUYET": "L√Ω Thuy·∫øt üìñ",
                "THUC_HANH": "Th·ª±c H√†nh üõ†Ô∏è",
                "NHOM_1": "Nh√≥m 1",
                "NHOM_2": "Nh√≥m 2",
                "NHOM_3": "Nh√≥m 3",
                "KHONG_PHAN_NHOM": "Kh√¥ng ph√¢n nh√≥m",
                "HOC_MOI": "H·ªçc m·ªõi",
                "HOC_LAI": "H·ªçc l·∫°i",
                "HOC_CAI_THIEN": "H·ªçc c·∫£i thi·ªán",
                "HOC_KY_1": "H·ªçc k·ª≥ 1",
                "HOC_KY_2": "H·ªçc k·ª≥ 2",
                "HOC_KY_3": "H·ªçc k·ª≥ 3",
            };
            if (databases[keyString]) {
                return databases[keyString];
            } else {
                return keyString;
            }
        }

        function formatDate(isoDate) {
            const date = new Date(isoDate);
            let ngay = date.getDate();
            let thang = date.getMonth() + 1; // V√¨ th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
            let nam = date.getFullYear();
            ngay = ngay < 10 ? '0' + ngay : ngay;
            thang = thang < 10 ? '0' + thang : thang;
            return ngay + '/' + thang + '/' + nam;
        }

        function getMondayAndSundayDates(currentDate) {
            // L·∫•y ng√†y c·ªßa tu·∫ßn
            var dayOfWeek = currentDate.getDay();
            
            // T√≠nh to√°n ng√†y c·ªßa th·ª© 2 (ng√†y b·∫Øt ƒë·∫ßu c·ªßa tu·∫ßn)
            var mondayDate = new Date(currentDate);
            mondayDate.setDate(currentDate.getDate() - (dayOfWeek - 1));
            
            // T√≠nh to√°n ng√†y c·ªßa ch·ªß nh·∫≠t (ng√†y cu·ªëi c·ªßa tu·∫ßn)
            var sundayDate = new Date(currentDate);
            sundayDate.setDate(currentDate.getDate() + (7 - dayOfWeek));
            
            // In ra k·∫øt qu·∫£
            console.log('Monday Date:', mondayDate.toLocaleDateString());
            console.log('Sunday Date:', sundayDate.toLocaleDateString());
        }
        // L·∫•y th·ªùi gian hi·ªán t·∫°i
        var currentDate = new Date('2020-01-01');

        // G·ªçi h√†m v·ªõi th·ªùi gian hi·ªán t·∫°i
        getMondayAndSundayDates(currentDate);
    </script>
</body>
</html>