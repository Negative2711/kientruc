<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELearning</title>
        <!-- boostrap 5 -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <!-- font awesome -->
        <script src="https://kit.fontawesome.com/ad778f42b3.js" crossorigin="anonymous"></script>
        <!-- jquery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <!-- toastr -->
        <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
        <!-- sweet alert -->
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <!-- css -->
        <link rel="stylesheet" href="../css/common.css">
    </head>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-12" id="ComponentDiv">
                <div class="d-lg-flex justify-content-between">
                    <div class="d-lg-flex text-center">
                        <img src="https://images.cooltext.com/5696045.png" width="176" height="44" alt="ELearning" class="crs" onclick="window.location.href= '/'" />
                        <img src="https://images.cooltext.com/5696047.png" width="32" height="30" alt="x" />
                        <img src="https://images.cooltext.com/5698020.png" alt="iuh-logo" />
                    </div>
                    <div class="d-flex align-items-center justify-content-center">
                        <div><i class="fas fa-bell crs"></i></div>
                        &emsp;
                        <div class="d-lg-flex text-center">
                            <img src="https://res.cloudinary.com/dopzctbyo/image/upload/v1672644566/sv_dkhp/sv-iuh-avatar-pattern_oyubmc.jpg" alt="avatar" width="32" height="32" class="rounded-circle avatar">
                            <div class="dropdown">
                                <span class="dropdown-toggle crs spanName" data-bs-toggle="dropdown">Phan Tấn Tài</span>
                                <ul class="dropdown-menu rounded-0">
                                <li><a class="dropdown-item" href="#">Link 1</a></li>
                                <li><a class="dropdown-item" href="#">Link 2</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="logout();">Log out</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-lg-12">
                <div class="bg-white p-3">
                    <p class="fs-3 fw-bold text-muted">Lịch học theo tuần</p>
                    <hr>
                    <div id="ControlBar" class="d-flex justify-content-between">
                        <div>
                            <input type="radio" name="select_loai_lich" id="lich_all" value="" class="form-check-input" onchange="onSelectLessionType(this.value);" checked />
                            <label for="lich_all">Tất cả</label>
                            <input type="radio" name="select_loai_lich" id="LICH_HOC" value="LICH_HOC" class="form-check-input" onchange="onSelectLessionType(this.value);" />
                            <label for="LICH_HOC">Lịch học</label>
                            <input type="radio" name="select_loai_lich" id="THI" value="THI" class="form-check-input" onchange="onSelectLessionType(this.value);" />
                            <label for="THI">Lịch thi</label>
                        </div>
                        <div class="mx-2"><input type="date" name="theDate" id="theDate" class="form-control" /></div>
                        <div>
                            <button type="button" class="btn btn-outline-dark btn-sm" onclick="onPreviousWeek();"><i class="fas fa-caret-left"></i> Tuần trước</button>
                            <button type="button" class="btn btn-outline-dark btn-sm" onclick="onCurrentWeek();">Hiện tại <i class="fas fa-undo-alt"></i></button>
                            <button type="button" class="btn btn-outline-dark btn-sm" onclick="onNextWeek();">Tuần kế <i class="fas fa-caret-right"></i></button>
                        </div>
                    </div>
                    <div id="DivTimeTable" class="mt-3">
                        <table class="table table-bordered">
                            <thead id="DivTimeTableHead" class="text-center">
                                <tr>
                                    <th>Buổi</th>
                                    <th>Thứ 2 <br> 22/04/2024</th>
                                    <th>Thứ 3 <br> 23/04/2024</th>
                                    <th>Thứ 4 <br> 24/04/2024</th>
                                    <th>Thứ 5 <br> 25/04/2024</th>
                                    <th>Thứ 6 <br> 26/04/2024</th>
                                    <th>Thứ 7 <br> 27/04/2024</th>
                                    <th>Chủ nhật <br> 28/04/2024</th>
                                </tr>
                            </thead>
                            <tbody id="DivTimeTableBody">
                                <tr>
                                    <td class="text-center" style="background: lightgrey; color: darkslategrey;">Sáng<br><i class="fas fa-cloud-sun small" data-bs-toggle="tooltip" title="Từ tiết 1-5"></i></td>
                                    <td id="tdST2"></td>
                                    <td id="tdST3"></td>
                                    <td id="tdST4"></td>
                                    <td id="tdST5"></td>
                                    <td id="tdST6"></td>
                                    <td id="tdST7"></td>
                                    <td id="tdSCN"></td>
                                </tr>
                                <tr>
                                    <td class="text-center table-secondary" style="background: lightgrey;color: darkslategrey;">Chiều<br><i class="fas fa-cloud-moon small" data-bs-toggle="tooltip" title="Từ tiết 7-12"></i></td>
                                    <td id="tdCT2"></td>
                                    <td id="tdCT3"></td>
                                    <td id="tdCT4"></td>
                                    <td id="tdCT5"></td>
                                    <td id="tdCT6"></td>
                                    <td id="tdCT7"></td>
                                    <td id="tdCCN"></td>
                                </tr>
                                <tr>
                                    <td class="text-center table-secondary" style="background: lightgrey; color: darkslategrey;">Tối<br><i class="fas fa-moon small" data-bs-toggle="tooltip" title="Từ tiết 13-15"></i></td>
                                    <td id="tdTT2"></td>
                                    <td id="tdTT3"></td>
                                    <td id="tdTT4"></td>
                                    <td id="tdTT5"></td>
                                    <td id="tdTT6"></td>
                                    <td id="tdTT7"></td>
                                    <td id="tdTCN"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Set default value for theDate
        document.getElementById('theDate').valueAsDate = new Date();
        var lessionTypeSelected = "";
        var jwtToken;
        var studentId;

        initSkeleton();

        async function initSkeleton() {
            validateSessionLogin();
            await fetchStudentDataAndRenderEmbbedVar();
        }

        function validateSessionLogin() {
            jwtToken = window.sessionStorage.getItem('token');
            if (!jwtToken || jwtToken == undefined || jwtToken == '') {
                window.location.href = "../html/student-login.html";
            }
            studentId = window.sessionStorage.getItem('studentId');
        }

        async function fetchStudentDataAndRenderEmbbedVar() {// Get student data & rendering embed var on page
            try {
                const response = await fetch(`http://localhost:8080/student/findById/${studentId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                const studentData = await response.json();
                // Render spanName
                $(".spanName").text(studentData.fullName);
                $(".avatar").attr('src', studentData.avatar);
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.message, 'Lỗi');
                throw error;
            }
        }

        $(document).ready(async function() {
            // 01. Get Student Data
            try {
                const response = await fetch(`http://localhost:8080/student/findById/${studentId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwtToken
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                const studentData = await response.json();
                // Render spanName
                $("#spanName").text(studentData.fullName);
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.message, 'Lỗi');
                throw error;
            }

            // 02. Init Get Current Timetables
            const currentDate = new Date();
            let dayOfWeek = currentDate.getDay();
            // Tính toán ngày của thứ 2 (ngày bắt đầu của tuần)
            let mondayDate = new Date(currentDate);
            mondayDate.setDate(currentDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            // Tính toán ngày của chủ nhật (ngày cuối của tuần)
            let sundayDate = new Date(currentDate);
            sundayDate.setDate(currentDate.getDate() + (7 - dayOfWeek + (dayOfWeek === 0 ? -6 : 0)));
            // In ra kết quả
            console.log('Monday Date:', mondayDate.toLocaleDateString());
            console.log('Sunday Date:', sundayDate.toLocaleDateString());
            renderHeaderTable(mondayDate, sundayDate);


            const response = await fetch(`http://localhost:8080/student/getTimeTablesByMonAndSun`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ studentId, mondayDate, sundayDate }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }
            const timeTables = await response.json();
            console.log('timeTables=', timeTables);
            renderBodyTable(timeTables);

            // 03. Listen theDate Change
            $("#theDate").change(async function() {
                const newCurrentDate = new Date($(this).val());
                let dayOfWeek = newCurrentDate.getDay();
                // Tính toán ngày của thứ 2 (ngày bắt đầu của tuần)
                let newMondayDate = new Date(newCurrentDate);
                newMondayDate.setDate(newCurrentDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                // Tính toán ngày của chủ nhật (ngày cuối của tuần)
                let newSundayDate = new Date(newCurrentDate);
                newSundayDate.setDate(newCurrentDate.getDate() + (7 - dayOfWeek + (dayOfWeek === 0 ? -6 : 0)));
                // In ra kết quả
                console.log('Monday Date:', newMondayDate.toLocaleDateString());
                console.log('Sunday Date:', newSundayDate.toLocaleDateString());
                renderHeaderTable(newMondayDate, newSundayDate);


                const response = await fetch(`http://localhost:8080/student/getTimeTablesByMonAndSun`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + jwtToken
                    },
                    body: JSON.stringify({ studentId, mondayDate: newMondayDate, sundayDate: newSundayDate, lessionType: lessionTypeSelected }),
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                const timeTables = await response.json();
                console.log('timeTables=', timeTables);
                renderBodyTable(timeTables);
            });
        });







        
        async function onSelectLessionType(lessionType) {
            console.log('lessionType=', lessionType);
            lessionTypeSelected = lessionType;
            $("#theDate").trigger("change");
        }
        async function onCurrentWeek() {
            const currentDate = new Date();
            const formattedDate = currentDate.toISOString().split('T')[0];
            $("#theDate").val(formattedDate).trigger("change");
        }
        async function onPreviousWeek() {
            const currentDateValue = $("#theDate").val();
            let currentDate = new Date(currentDateValue);
            currentDate.setDate(currentDate.getDate() - 7);
            const formattedDate = currentDate.toISOString().split('T')[0];
            $("#theDate").val(formattedDate).trigger("change");
        }
        async function onNextWeek() {
            const currentDateValue = $("#theDate").val();
            let currentDate = new Date(currentDateValue);
            currentDate.setDate(currentDate.getDate() + 7);
            const formattedDate = currentDate.toISOString().split('T')[0];
            $("#theDate").val(formattedDate).trigger("change");
        }

        async function renderBodyTable(timeTables) {
            const dayInWeek = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];
            for(let i=0;i<dayInWeek.length;i++) {
                $("#tdS"+dayInWeek[i]).html("");
                $("#tdC"+dayInWeek[i]).html("");
                $("#tdT"+dayInWeek[i]).html("");
            }
            const belongOfMorning = ["T1", "T2", "T3", "T4", "T5", "T6"];
            const belongOfAfternoon = ["T7", "T8", "T9", "T10", "T11", "T12"];
            const belongOfTonight = ["T13", "T14", "T15", "T16"];
            timeTables.forEach(timeTable => {
                console.log('timeTable==================', timeTable);
                const tdCell = 
                '<div class="rounded-3 border m-2 p-2" style="background: #e1e4e6;">'+
                    '<div class="text-center">'+
                        `<span class="fw-bold">${timeTable.subject.subjectName}</span>`+
                        '<br>'+
                        `<span>${timeTable.sectionClass.sectionClassNamePresent} -</span>`+
                        '<br>'+
                        `<span>(${timeTable.sectionClass.id})</span>`+
                    '</div>'+
                    '<ul>'+
                        `<li><span>Tiết: ${timeTable.timeTable.startLessionTime.substr(1,2)} - ${timeTable.timeTable.endLessionTime.substr(1,2)}</span></li>`+
                        `<li><span>Phòng: ${timeTable.timeTable.room}</span></li>`+
                        `<li><span>GV: ${timeTable.teacher.rankAlias} ${timeTable.teacher.fullName}</span></li>`+
                        `<li><span>Ghi chú: ${timeTable.timeTable.note}</span></li>`+
                    '</ul>'+
                '</div>';
                if(belongOfMorning.includes(timeTable.timeTable.startLessionTime)) {
                    $("#tdS"+timeTable.timeTable.lessionDay).append(tdCell);
                    if(timeTable.timeTable.lessionType == 'THI')
                        $("#tdS"+timeTable.timeTable.lessionDay + " > div").css({"background-color": "#fad905", "border": "1px double orange"});
                }
                if(belongOfAfternoon.includes(timeTable.timeTable.startLessionTime)) {
                    $("#tdC"+timeTable.timeTable.lessionDay).append(tdCell);
                    if(timeTable.timeTable.lessionType == 'THI')
                        $("#tdC"+timeTable.timeTable.lessionDay + " > div").css({"background-color": "#fad905", "border": "1px double orange"});
                }
                if(belongOfTonight.includes(timeTable.timeTable.startLessionTime)) {
                    $("#tdT"+timeTable.timeTable.lessionDay).append(tdCell);
                    if(timeTable.timeTable.lessionType == 'THI')
                        $("#tdT"+timeTable.timeTable.lessionDay + " > div").css({"background-color": "#fad905", "border": "1px double orange"});
                }
            });
        }

        function renderHeaderTable(mondayDate, sundayDate) {
            // Clear previous header
            $("#DivTimeTableHead").empty();

            // Add headers for each day of the week
            let days = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
            let currentDate = new Date(mondayDate);
            let theadContent = '<tr><th>Buổi</th>';

            while (currentDate <= sundayDate) {
                let formattedDate = currentDate.toLocaleDateString('en-GB');
                let dayOfWeek = currentDate.getDay();
                theadContent += `<th>${days[dayOfWeek]} <br> ${formattedDate}</th>`;
                currentDate.setDate(currentDate.getDate() + 1); // Move to next day
            }

            theadContent += '</tr>';
            $("#DivTimeTableHead").append(theadContent);
        }

        function logout() {
            window.sessionStorage.clear();
            window.sessionStorage.removeItem('mssv');
            window.sessionStorage.removeItem('studentId');
            window.sessionStorage.removeItem('token');
            window.location.href = "./student-login.html";
        }
    </script>
</body>
</html>