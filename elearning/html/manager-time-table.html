<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELearning</title>
    <!-- boostrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <!-- font awesome -->
    <script src="https://kit.fontawesome.com/ad778f42b3.js" crossorigin="anonymous"></script>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- toastr -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/manager-time-table.css">
    <!-- select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <style>
        .select2-selection__rendered {
            line-height: 28px !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row" style="height: 100vh;">
            <div class="col-lg-2 border-end p-3">
                <div class="my-1">
                    <button class="myButton3" onclick="window.location.href=('./manager-home.html');">Home</button>
                </div>
                <div class="my-1">
                    <button class="myButton3" onclick="window.location.href=('./manager-section-class.html');">Quản lý LHP</button>
                </div>
                <div class="mt-2">
                    <button class="myButton2">Quản lý TKB</button>
                </div>
            </div>
            <div class="col-lg-10">
                <div class="d-flex my-3">
                    <a href="./manager-home.html">Home</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="./manager-time-table.html">Time table</a>
                    <div>&emsp;>&emsp;</div>
                    <a href="javascript:void(0);">Create new</a>
                </div>
                <form id="FormTimeTable" method="post">
                    <div>
                        <label for="">Từ tiết</label>
                        <input type="text" name="startLessionTime" placeholder="Nhập startLessionTime">
                    </div>
                    <div>
                        <label for="">Đến tiết</label>
                        <input type="text" name="endLessionTime" placeholder="Nhập endLessionTime" >
                    </div>
                    <div>
                        <label for="">Loại tiết học</label>
                        <input type="text" name="lessionType" placeholder="Nhập lessionType" >
                    </div>
                    <div>
                        <label for="">Ghi chú</label>
                        <input type="text" name="note" placeholder="Nhập note" >
                    </div>
                    <div>
                        <label for="">Phòng</label>
                        <input type="text" name="room" placeholder="Nhập room" >
                    </div>
                    <div>
                        <label for="">Thứ học</label>
                        <input type="text" name="lessionDay" placeholder="Nhập lessionDay">
                    </div>
                    <div>
                        <label for="">Ngày học</label>
                        <input type="date" name="lessionDate" placeholder="Nhập lessionDate">
                    </div>
                    <div>
                        <label for="">Mã nhóm lớp học phần</label>
                        <select name="sectionClassGroupId" class="js-example-sectionclassgroup-select2-single">
                            <option value="" selected>Vui lòng chọn mã nhón LHP</option>
                        </select>
                    </div>
                    <div>
                        <label for="">Tự động generate lịch cho các tuần sau: </label>
                        <div class="d-flex border">
                            <div>
                                <label for="autoGenerateFalse">False</label>
                                <input type="radio" name="isAutoGenerated" id="autoGenerateFalse" value="false" checked />
                            </div>
                            <div>
                                <label for="autoGenerateTrue">True</label>
                                <input type="radio" name="isAutoGenerated" id="autoGenerateTrue" value="true" />
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btnSubmit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        varjwtToken;
        initSkeleton();

        async function initSkeleton() {
            validateSessionLogin();
            await setSectionClassGroupSelection(); // Lấy ra list sectionClassesGroup & render
        }

        function validateSessionLogin() {
            jwtToken = window.sessionStorage.getItem('token');
            if (!jwtToken || jwtToken == undefined || jwtToken == '') {
                window.location.href = "./manager-login.html";
            }
        }

        async function setSectionClassGroupSelection() {
            try {
                const response = await fetch(`http://localhost:8080/manager/sectionClassGroup/list`, {// Get Subjects
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxOTUyNDc5MSIsInJvbGUiOiJTVFVERU5UIiwiaWF0IjoxNzE1MjM0MTcyLCJleHAiOjE3MTUyNzAxNzJ9.-Wd9uoKMeMQkU2kdrX8dU0GALd_DfOUD9mDq6CKx5XI',
                    },
                });
                const customSectionClassesGroup = await response.json();
                $('.js-example-sectionclassgroup-select2-single').select2({
                    placeholder: "Chọn mã nhóm LHP",
                    allowClear: true,
                    data: customSectionClassesGroup.map(function(customSectionClassGroup) {
                        return {
                            id: customSectionClassGroup.sectionClassGroup.id,
                            text: customSectionClassGroup.sectionClassGroup.id + ' - ' + customSectionClassGroup.sectionClass.sectionClassNamePresent + ' - ' + translateEnumric(customSectionClassGroup.sectionClassGroup.classGroupName)
                        };
                    }),
                });
            } catch (error) {
                console.error('error=', error);
                toastr.error(error.responseText, 'Lỗi');
            }
        }
        $(document).ready(function(){
            $("#FormTimeTable").submit(async function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                console.log('formData=', formData);
                for (const [name, value] of formData.entries()) {
                    console.log(`${name}: ${value}`);
                }
                const endLessionTime = formData.get('endLessionTime');
                const lessionType = formData.get('lessionType');
                const note = formData.get('note');
                const room = formData.get('room');
                const startLessionTime = formData.get('startLessionTime');
                const lessionDay = formData.get('lessionDay');
                const lessionDate = formData.get('lessionDate');
                const sectionClassGroupId = formData.get('sectionClassGroupId');
                const isAutoGenerated = formData.get('isAutoGenerated');

                // Pineline data
                const timeTableDTO = {
                    endLessionTime,
                    lessionType,
                    note,
                    room,
                    startLessionTime,
                    lessionDay,
                    lessionDate,
                    sectionClassGroupId,
                    isAutoGenerated
                };
                try {
                    const response = await fetch(`http://localhost:8080/manager/timeTable/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json; charset=utf-8',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxOTUyNDc5MSIsInJvbGUiOiJTVFVERU5UIiwiaWF0IjoxNzE0MDE3MTU0LCJleHAiOjE3MTQwNTMxNTR9.sxOzGxrZroGasOiCKFnVtv8qOtg28iBrZjVneKP7vqE',
                        },
                        body: JSON.stringify(timeTableDTO)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }
                    const data = await response.text();
                    console.log('data=', data);
                    toastr.success(response.status, 'Thành công');
                } catch (error) {
                    console.error('error=', error);
                    toastr.error(error.responseText, 'Lỗi');
                }
            });
        });

        function translateEnumric(keyString) {
            const databases = {
                "DANG_CHO_SINH_VIEN_DANG_KY": "Đang chờ sinh viên đăng ký",
                "CHAP_NHAN_MO_LOP": "Chấp nhận mở lớp ⚠️",
                "DA_KHOA": "Đã khóa ⛔",
                "LY_THUYET": "Lý Thuyết 📖",
                "THUC_HANH": "Thực Hành 🛠️",
                "NHOM_1": "Nhóm 1",
                "NHOM_2": "Nhóm 2",
                "NHOM_3": "Nhóm 3",
                "KHONG_PHAN_NHOM": "Không phân nhóm",
                "HOC_MOI": "Học mới",
                "HOC_LAI": "Học lại",
                "HOC_CAI_THIEN": "Học cải thiện",
                "HOC_KY_1": "Học kỳ 1",
                "HOC_KY_2": "Học kỳ 2",
                "HOC_KY_3": "Học kỳ 3",
            };
            if (databases[keyString]) {
                return databases[keyString];
            } else {
                return keyString;
            }
        }
    </script>
</body>
</html>